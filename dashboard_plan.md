# План дашборда визуализации

## Анализ кодовой базы
- `src/moex_all_in_one_v2.py`: универсальный процессинг логов — скачивает OHLC-данные, строит equity, может возвращать отчёт и график, уже учитывает комиссию (`comis`) и сохраняет промежуточные файлы (candles, steps). Именно отсюда будем брать данные для каждого лог-файла.
- `src/equity_combination.py`: объединяет несколько equity-логов, рассчитывает метрики, строит Plotly-график с общей кривой и per-инструментными линиями, умеет возвращать `CombinedEquityResult` с одинаковым форматом. Подходит для построения вкладки «Комбинация» и хранения результатов.
- `file_selector.py`: примитивный селектор файлов для Jupyter/ipywidgets с сохранением выбора в `last_selected_tickers.json`. Логику запоминания можно переиспользовать (или переписать под Streamlit) для выборки логов и хранения последних путей.
- `equity_combination_demo.ipynb` и `equity_debug.ipynb`: полезные сценарии использования библиотек, особенно последовательность выбора логов и вызов `combine_equity_logs`; можно перенести шаги в дашборд с аналогичным UX (выбор файлов → запуск обработки → просмотр метрик/графиков).
- Ноутбуки и скрипты активно похожи на линейный workflow, что хорошо сочетается с моделью Streamlit, где каждый виджет выполняется в порядке сверху вниз и хранит состояние (или `st.session_state`).

## Цели дашборда
1. Привычный поток: пользователь выбирает папку с логами → отмечает интересующие файлы → применяет фильтры → получает графики Plotly для каждого лога и/или комбинированную кривую.
2. Конфигурация (путь к логам, комиссия и режим отображения) должна запоминаться между запусками, чтобы при перезапуске не терялись параметры.
3. Альтернатива комбинации/перебора: при множественном выборе логов можно переключаться между режимом «показывать совокупную кривую» и «отдельные графики» через выпадающее меню.
4. Можно сохранять CSV (например, equity-таблицу) отдельно для каждого лог-файла на диск (скорее всего, предложить путь сохранения и кнопку «Экспорт»).
5. Подключение Plotly позволяет не переписывать визуализации — использовать `st.plotly_chart` прямо на основе данных из `process_log_v2` и `combine_equity_logs`.

## Предлагаемая структура дашборда (Streamlit)
1. **Боковая панель (sidebar)**  
   - Путь к папке с логами (ввести вручную + кнопка обзора).  
   - Кнопка «Запомнить папку»/автоматическое сохранение значения в `st.session_state` с fallback на JSON (аналог `file_selector`).  
   - Поле для ввода комиссии (можно сохранить в `session_state` или локально).  
   - Переключатель режима отображения: `st.selectbox(["Комбинация", "По одному"])`.

2. **Основной экран**  
   - Заголовок + подсказка по выбору логов.  
   - Зона выбора файлов (на основе `Path.rglob` и чекбоксов), поддерживающая множественный выбор и сохраняя выбранную пару `(имя, путь)` между перезагрузками.  
   - Кнопка «Загрузить/Обновить данные», которая запускает `process_log_v2` (можно асинхронно/с кешем `st.cache_data`).
   - Если выбраны ≥1 логов:
     * В подзаголовке — карточки с ключевыми метриками (final equity, drawdown, комиссия, период).  
     * Plotly-график `combine_equity_logs` (если режим «Комбинация» или выбран только один лог).  
     * Если режим «По одному»: пять отдельных графиков (или вкладки) с `process_log_v2(..., show_plot=True, build_equity_report=True)` и `st.plotly_chart`. Можно показывать таблицу с `per_logs`.
   - Блок «Экспорт CSV»: кнопка для каждого лога «Сохранить equity → CSV» (воспользоваться `LogEquitySnapshot.equity.to_csv`), можно предложить диалог с выбором директории или использовать заранее указанную папку.

3. **Панель фильтров (можно сверху или в отдельной колонке)**  
   - Фильтрация по диапазону дат (две даты).  
   - Фильтрация по тикеру (если `process_log_v2` умеет).  
   - Выбор метрики: визуализировать equity, bot_equity, current_pos. (Дублирует существующий `plot_column`.)

## Особенности реализации
- Хранение состояния: использовать `st.session_state` или JSON-файл в `help_data` (аналог `last_selected_tickers.json`) для:
  1. Последней папки логов.  
  2. Последней комиссии.  
  3. Последнего режима отображения (комбинация/по одному).  
- При выборе множества файлов: по умолчанию показывать комбинированную кривую; выпадающее меню меняет отображение (для «По одному» можно итеративно выводить таблички/графики, а для «Комбинации» — один Plotly-диаграмму с overlay).
- При экспорте CSV: сделать кнопку, которая вызывает `st.download_button` с `df.to_csv` или сохраняет в указанную папку; для каждого лог-файла будет отдельная строка/контроль со ссылкой на файл.
- Комиссия: поле ввода `st.number_input` с предусловием, что значение сохраняется и передаётся в `process_log_v2(..., comis=commission)`, чтобы метрики отражали реалистичные издержки.
- Важно: сохранять `steps_reference` и `OHCL` — использовать существующие директории (`help_data`, `OHCL`), чтобы не дублировать загрузку данных.

## План реализации
1. Подготовить `streamlit`-приложение (`app.py`), завести глобальные функции для загрузки логов и вызова `combine_equity_logs`; добавить `st.cache_data`/`st.cache_resource` вокруг `process_log_v2` при необходимости.  
2. Реализовать sidebar с состояниями (путь, комиссия, режим). Тем же файлом JSON дублировать `file_selector`-поведение.  
3. Центральную часть: выбор файлов, кнопка «Обновить», отображение Plotly (в режиме «Комбинация»).  
4. Блок «По одному» с итерацией по `result.per_logs`, карточками метрик, кнопками «Сохранить CSV» (`st.download_button`).  
5. Дополнительно: фильтры по датам/тикерам и секция с логами/отчётами (метрики `CombinedEquityMetrics`, `EquityReport`).

## Следующие шаги
- Запустить `streamlit run app.py` и проверить сохранение выбора.  
- Проверить экспорты CSV: при клике файл должен быть сформирован корректно.  
- Добавить тесты/снэпшоты для критичных частей (например, `combine_equity_logs` уже покрыто, можно добавить тесты UI-логики только вручную).
