# План облегчения приложения и интерфейса

## Коротко о текущем состоянии
- Интерфейс: `app.py` на Streamlit, замешан Tkinter для выбора папки, Plotly для графиков; текст в UI повреждён из-за неверной кодировки.
- Логика: ядро в `src/` (`moex_all_in_one_v2.py`, `equity_combination.py`, `data/*`) — скачивание OHLC через `moexalgo`, сборка equity (`equity_builder.py`/`_v2`), отчёты (`equity_report.py`), комбинирование нескольких логов.
- Данные: кэш OHLC в `OHCL/`, вспомогательные файлы в `help_data/`. Хранится состояние дашборда `help_data/dashboard_state.json`.
- Тесты: только базовая проверка скачивания справочника (`tests/test_basic.py`), нет покрытия UI и расчётной логики.
- Требования: в `requirements.txt` нет Streamlit/Plotly/moexalgo, зато много инструментов разработки — дистрибутив раздувается лишними пакетами.

## Основные боли
- Каждая смена состояния Streamlit вызывает повторную переработку файлов; нет явной мемоизации по пути файла/времени модификации/комиссии.
- Перемешаны функции UI и вычислений; тяжело переиспользовать расчёты без Streamlit.
- Дублирование сборки equity (v1/v2) и частичная размытость по колонкам/кодировкам; много аварийных путей с плохими сообщениями об ошибке.
- Качество текстов (битая кодировка) ухудшает UX; смешение Tkinter + Streamlit увеличивает размер сборки и даёт лишние зависимости.
- Пакетирование: PyInstaller тянет весь Streamlit/Plotly; нет лёгкого CLI-режима для headless расчётов.

## Цели оптимизации
1) Отделить вычислительное ядро от интерфейса, чтобы UI был заменяемым и не провоцировал перезапуски расчётов.  
2) Снизить зависимости в прод-сборке (оставить только то, без чего нет функционала).  
3) Сделать UX предсказуемым: явные кнопки «Загрузить/Пересчитать», грамотное кэширование, понятные ошибки.  
4) Дать альтернативу Streamlit: либо облегчённый Streamlit-слой, либо полностью автономный CLI/статический HTML отчёт.

## План по коду ( ядро )
- Вынести сервисный слой:
  - `src/services/files.py`: поиск логов, маска, кеширование списка через дату mtime.
  - `src/services/equity.py`: фасад `build_equity_bundle(log_paths, comis, tz)` → `CombinedEquityResult`, без Streamlit.
  - `src/services/cache.py`: простая мемоизация `@lru_cache`/`diskcache` по `(path, mtime, comis)`.
- Свести сборку equity к одной версии:
  - Сравнить `equity_builder.py` и `_v2`; оставить единый путь с параметрами, закрыть копипасту по заполнению колонок.
  - Явно нормализовать datetime/encoding на входе (UTF-8 по умолчанию, явное cp1251 только там, где нужно).
- Привести сообщения к понятному русскому/английскому, избавиться от битой кодировки; завести единый `strings.py`.
- Разнести загрузку OHLC:
  - Чётко отделить сетевые вызовы `moexalgo` от постобработки; добавить фолбэк на локальный кэш без сети.
  - Сделать ограничитель запросов и явное логирование «что качаем и зачем».
- Тесты:
  - Юниттесты на `_max_drawdown`, `_longest_drawdown_window`, `combine_equity_logs` (фикстуры c минимальными CSV).
  - Контрактные тесты на `load_transform_csv` (разные колонок/кодировки).
  - Моки для `moexalgo.Ticker` чтобы тесты не ходили в сеть.

## Интерфейсы: варианты

### A. Лёгкий Streamlit 2.0 (минимум переделок)
- Убрать Tkinter, заменить на `st.file_uploader` или `st.text_input` пути + кнопку «Сканировать».
- Ввести чёткую кнопку `Пересчитать` → кешировать результат в `st.session_state["result"]` и `st.cache_data` по `(path, mtime, comis)`.
- Явно разделить «скан файлов» и «расчёт»: смена маски не должна пересчитывать график, только список.
- Заменить тяжёлый Plotly там, где можно, на `st.line_chart`/Altair; оставить Plotly только для комбинированного графика.
- Добавить компактный режим: только суммарные метрики + кнопка «Показать детали» для каждого лога (ленивая отрисовка).
- Переписать текст/локализацию на нормальный UTF-8, вынести строки в константы.

### B. CLI + статический отчёт (альтернатива без Streamlit)
- Однокомандный инструмент `python -m src.cli combine --logs path/*.t.csv --comis 0.5 --html out/report.html`.
- Внутри: использует тот же сервисный слой, рендерит Plotly в `plotly.io.write_html` или Matplotlib PNG + Markdown-отчёт.
- Можно запускать без GUI/браузера, дружит с PyInstaller-монолитом; хуб для автоматизации.
- Минимальный просмотрщик: простой `index.html` + JS с данными вlined (чтобы не тащить streamlit/altair).

### C. TUI/desktop опция (по желанию)
- Текстовый интерфейс на `textual` или `rich` (легче Streamlit) с выбором файлов и выводом метрик; графики экспортируются в PNG/HTML.
- Desktop на `flet`/`tkinter` только если нужен drag&drop; иначе не трогаем.

## Пакетирование и зависимости
- Разделить `requirements.txt`:
  - `base` (pandas, requests, moexalgo, plotly/altair).
  - `dev` (black, flake8, pytest, pre-commit).
  - `ui-streamlit` (streamlit) — опционально.
- Для PyInstaller: два entry point’а — `streamlit_app` (опционально) и `cli_report`. Добавить `--exclude-module` для dev-инструментов.
- Убрать Tkinter-зависимость (она встроена, но утяжеляет exe, даёт лишние окна).

## Быстрые победы (1–2 дня)
- Исправить текст/кодировку в `app.py`, убрать Tkinter, добавить кнопку «Пересчитать» с кешем по mtime/комиссии.
- Добавить `streamlit`/`plotly`/`moexalgo` в `requirements.txt` или вынести в `requirements-ui.txt`.
- Минимальный CLI `scripts/combine_equity.py` для headless расчёта + сохранения CSV/PNG.

## Метрические цели
- Пересчёт одного и того же набора файлов не должен трогать сеть и должен укладываться в 1–2 секунды (за счёт кеша).
- Бандл exe < 120–150 МБ за счёт отказа от dev-зависимостей и Tkinter.
- Покрытие тестами ключевых подсчётов ≥ 60% модулей `src/data` и `equity_combination.py`.

## Открытые вопросы
- Нужно ли полностью offline-решение (без скачивания OHLC), если данные уже есть?
- Какой минимальный набор метрик критичен? Можно ли убрать часть отчёта ради скорости?
- Нужен ли экспорт в Excel/Markdown помимо CSV/HTML?
