

# **REFactor_PLAN.md — Пошаговый план рефакторинга проекта**

Документ для Codex.
Следуй шагам последовательно. Не переходи к следующему разделу, пока не завершены предыдущие.

---

## **0. Цели проекта**

* Упростить UI на Streamlit, полностью убрать Tkinter.
* Выделить вычислительное ядро в сервисный слой `src/services/`.
* Объединить версии equity-builder в одну.
* Обеспечить быструю докачку OHLC через `moexalgo` с локальным кэшем.
* Обеспечить расчёт трёх ключевых метрик: ГО, доходность % от ГО, дроудаун % от ГО.
* Создать CLI-режим для headless расчётов (только CSV).
* Нормализовать зависимости: base / dev / ui.
* Увеличить покрытие тестами.

---

# **ЭТАП 1 — Быстрые победы (1–2 дня)**

Не двигаться дальше, пока не выполнен каждый пункт.

## **1.1 Удаление Tkinter и подготовка Streamlit**

* [x] Убрать весь Tkinter из проекта. — выполненно
* [x] В `app.py` заменить выбор папки на: — выполненно

  * [x] `st.file_uploader` — для загрузки логов — выполненно
  * [x] `st.text_input` — для ввода пути к папке + маски — выполненно
* [x] Добавить кнопку `"Сканировать"` ➜ вызывает функцию поиска логов. — выполненно
* [x] Добавить кнопку `"Пересчитать"` ➜ вызывает расчёт через будущий сервисный слой. — выполненно
* [x] Привести все тексты в `app.py` к UTF-8. — выполненно

**Готово, когда:**
UI работает без Tkinter, логи сканируются отдельной кнопкой, расчёт вызывается отдельной кнопкой.

---

## **1.2 Временное кэширование расчётов**

* [x] Добавить `st.cache_data` вокруг временной функции расчёта equity. — выполненно
* [x] Ключ кэша: `(log_paths, mtime, comis)`. — выполненно
* [x] Результат класть в `st.session_state["result"]`. — выполненно

**Готово, когда:**
Повторный расчёт тех же логов выполняется за < 1–2 секунд.

---

## **1.3 Добавление недостающих зависимостей**

* [ ] Добавить в `requirements.txt`:

  * `streamlit`
  * `plotly`
  * `moexalgo`
* [ ] (Опционально) Разнести зависимости на:

  * `requirements-base.txt`
  * `requirements-dev.txt`
  * `requirements-ui.txt`

---

## **1.4 CLI-скрипт (минимальная версия)**

Создать `scripts/combine_equity.py`:

* [ ] Принимает маску логов, комиссию.
* [ ] Вызывает существующую логику (временно — старый код, пока служебный слой не сделан).
* [ ] Выводит CSV с equity/метриками.

**Готово, когда:**
Можно выполнить:

```
python scripts/combine_equity.py --logs "path/*.csv" --comis 0.5 --out result.csv
```

---

# **ЭТАП 2 — Создание сервисного слоя (ядро проекта)**

Без работы с UI.

## **2.1 Сервис: поиск логов**

Создать `src/services/files.py`:

* [ ] Функция поиска логов по маске.
* [ ] Кэш списка логов по: путь → маска → mtime файлов.
* [ ] Структура `LogFileInfo`.

---

## **2.2 Сервис: OHLC и кэш**

Создать `src/services/ohlc.py`:

* [ ] `fetch_ohlc(ticker, start, end, timeframe="1m")` — скачивание через `moexalgo`.
* [ ] `get_ohlc_cached(...)` — докачка недостающих свечей.
* [ ] Сохранение свечей в `OHCL/` (CSV или Parquet).
* [ ] Логирование действий.

---

## **2.3 Сервис: ядро equity**

Создать `src/services/equity.py`:

* [ ] Унифицированная функция:

  ```
  build_equity_bundle(log_paths, comis, tz) -> CombinedEquityResult
  ```
* [ ] Включить расчёт 3 метрик:

  * расчётное ГО,
  * доходность % от ГО,
  * максимальный дроудаун % от ГО.
* [ ] Структура `CombinedEquityResult`.

---

# **ЭТАП 3 — Объединение equity-builder'ов**

## **3.1 Анализ и слияние v1/v2**

* [ ] Проанализировать `equity_builder.py` и `_v2`.
* [ ] Убрать копипасту, оставить одну реализацию.
* [ ] Сделать единые поля DataFrame.

---

## **3.2 Унифицированные функции**

* [ ] `build_single_equity(log_path, comis, tz)`
* [ ] `combine_equity_logs(equities)`

Метрики должны считаться в этом же месте.

---

# **ЭТАП 4 — Финальная версия UI (Streamlit Lite)**

## **4.1 Новая структура UI**

* [ ] Чёткое разделение:

  * “Сканировать” → список логов
  * “Пересчитать” → расчёт
* [ ] Хранение состояния в `st.session_state["logs"]` и `["result"]`.

---

## **4.2 Графики**

* [ ] Простые графики → `st.line_chart` / Altair.
* [ ] Сложные комбинированные графики → Plotly.
* [ ] Кнопка “Показать детали” → ленивая отрисовка каждого графика.

---

# **ЭТАП 5 — CLI v2 (финальный)**

* [ ] CLI использует сервисный слой (не старый код).
* [ ] Полноценный экспорт CSV с equity и метриками.
* [ ] Опционально: сохранение графика в HTML.

---

# **ЭТАП 6 — Тесты**

## **6.1 Юнит-тесты**

* [ ] `_max_drawdown`
* [ ] `_longest_drawdown_window`
* [ ] `combine_equity_logs`
* [ ] Парсинг CSV (UTF-8 / CP1251)

## **6.2 Моки для moexalgo**

* [ ] Тесты не должны ходить в сеть.
* [ ] Проверка докачки OHLC с неполным диапазоном.

Цель: покрытие ≥ 60% в key-модулях.

---

# **ЭТАП 7 — Оптимизация зависимостей и сборки**

* [ ] Разнести `requirements-base`, `requirements-ui`, `requirements-dev`.
* [ ] Для PyInstaller:

  * отдельный entry point Streamlit
  * отдельный entry point CLI
  * исключить dev-модули

---

# **Финальный критерий готовности**

Проект считается успешно рефакторингованным, когда:

* UI работает быстро, расчёты не повторяются без необходимости.
* OHLC докачиваются автоматически и лишь недостающие интервалы.
* Логика полностью отделена от интерфейса.
* Метрики ГО/доходность/дроудаун считаются единообразно.
* CLI умеет рассчитывать и сохранять CSV без Streamlit.
* Тесты покрывают ≥ 60% ключевой логики.

---

# **КОНЕЦ ПЛАНА**
