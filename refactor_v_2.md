# **REFactor_PLAN_v2 — перестроенный план работ**

Эта версия группирует задачи по логичным этапам, уточняет зависимости и добавляет чекбоксы для отслеживания прогресса.

---

## **0. Цели проекта (перенесены из оригинала)**

* [x] Оставить UI полностью на Streamlit и убрать Tkinter.
* [ ] Перенести логику equity в `src/services/`.
* [ ] Объединить обе реализации equity-builder и выделить общие helper’ы.
* [ ] Обеспечить постепенное скачивание OHLC через `moexalgo` с кэшированием.
* [ ] Всегда рассчитывать три метрики: ГО, доходность % от ГО, дроудаун % от ГО.
* [ ] Поддерживать CLI для headless расчета и экспорта CSV.
* [ ] Разделить зависимости на `requirements-base`, `requirements-ui`, `requirements-dev`.
* [ ] Повысить покрытие тестами, особенно для ключевых модулей.

---

## **1. Быстрые победы (оригинальный этап 1 — завершён)**

* [x] Убрать Tkinter и перейти на Streamlit-виджеты (`file_uploader`, `text_input`, кнопки и т.п.).
* [x] Добавить явные кнопки «Сканировать» и «Пересчитать» и привести все строки к UTF-8.
* [x] При очищенном поле маски использовать по умолчанию `*t.csv`.
* [x] Кэшировать расчёт equity в `st.cache_data` по ключу `(log_paths, mtime, comis)` и хранить результат в `st.session_state["result"]`.

Этап завершён — логика UI уже работает автономно, переходим к ядру.

---

## **2. Объединение equity-builder’ов (замена предыдущих 3.1/3.2)**

Это нужно сделать перед написанием сервисного слоя, потому что сервисы опираются на общие helper’ы.

* [x] Сравнить `src/data/equity_builder.py` и `_v2`: понять различия в ожидаемых колонках, таймлайнах, поведении `current_pos` и т.д.
* [x] Слить оба варианта в единую реализацию с согласованными названиями колонок (`action_price`, `deal_price`, `current_pos` и пр.).
* [x] Выделить helper’ы:
  * [x] `build_single_equity(log_path, comis, tz)` — обрабатывает один лог и возвращает DataFrame.
  * [x] `combine_equity_logs(equities)` — объединяет несколько DataFrame и возвращает `CombinedEquityResult` с метриками ГО, доходности и дроудауна.
* [x] Переписать affected tests и типы в соответствии с новым интерфейсом.

После этапа останется одна надёжная реализация equity для UI и CLI.

---

## **3. Сервисный слой**

### **3.1 Поиск логов (`src/services/files.py`)**

* [x] Реализовать `discover_logs(path, mask)` с кэшированием по `(path, mask, mtimes)`.
* [x] Добавить DTO `LogFileInfo` (путь, mtime, размер, метаданные тикера).
* [x] Сохранять последний результат сканирования, чтобы Streamlit и CLI могли повторно использовать его без перезапроса файловой системы.

### **3.2 Кэш OHLC (`src/services/ohlc.py`)**

* [x] Предоставить `fetch_ohlc(ticker, start, end, timeframe="1m")` через `moexalgo`.
* [x] Добавить `get_ohlc_cached(...)`, дополняющий отсутствующие свечи и сохраняющий их в `OHCL/` (CSV/Parquet).
* [x] Логировать действия кэша и поддерживать обновление только пропущенных диапазонов.

### **3.3 Equity bundle (`src/services/equity.py`)**

* [x] Использовать `build_single_equity`/`combine_equity_logs` внутри сервисных функций.
* [x] Выделять метрики: ГО, доходность % от ГО, дроудаун % от ГО, финальный equity, общая комиссия.
* [x] Интерфейс `build_equity_bundle(log_paths, comis, tz, cache_key=None) -> CombinedEquityResult`.
* [x] Чётко логировать ошибки и поддерживать режим «один лог» для CLI.

Слой сервисов должен быть не привязан к UI — Streamlit и CLI работают над ним.

---

## **4. Streamlit UI (перепривязать к сервисам)**

* [x] Sidebar по-прежнему содержит папку/маску/комиссию, но:
  * [x] «Сканировать» вызывает `discover_logs`.
  * [x] «Пересчитать» вызывает `build_equity_bundle`.
* [x] Хранить найденные логи и последний результат в `st.session_state["logs"]` и `["result"]`.
* [x] Построение комбинированных и per-log графиков базировать на `CombinedEquityResult`.

Когда этап завершён, UI просто оркеструет сервисные вызовы.

---

## **5. CLI и headless расчёты**

* [x] Реализовать команду `python -m scripts.combine_equity --logs "path/*.t.csv" --comis 0.5 --out result.csv`.
* [x] CLI вызывает `discover_logs`, затем `build_equity_bundle`.
* [x] Сохранять CSV с equity, метриками и, опционально, графиками Plotly/Matplotlib.
* [x] Добавить флаг `--html` для экспорта графика (по желанию).

---

## **6. Тесты**

* [x] Юнит-тесты для `_max_drawdown`, `_longest_drawdown_window`, `combine_equity_logs`, парсинга CSV (UTF-8/CP1251).
* [x] Моки для `moexalgo`, моделирующие недостающие OHLC.
* [x] Тесты CLI и Streamlit (например, с моками `st.session_state`).

Цель — ≥60 % покрытия ключевых модулей.

---

## **7. Зависимости и сборка**

* [ ] Разделить зависимости на `requirements-base.txt`, `requirements-ui.txt`, `requirements-dev.txt`.
* [ ] Подготовить PyInstaller-сборку:
  * [ ] entry point для Streamlit.
  * [ ] entry point для CLI.
  * [ ] исключить dev-only зависимости.

После этого проект готов для упаковки и релиза.
