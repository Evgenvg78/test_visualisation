# Анализ и предложения по улучшению Streamlit-оболочки

## Основные наблюдения
- Состояния: сейчас папка/маска/комиссия/режим хранятся в `session_state` + JSON. Глобальные ключи простые, но перемешаны с логикой виджетов; есть `st.rerun()` при выборе папки → это норм, но важно избегать лишних перезапусков.
- Получение данных: всё пересчитывается при каждом нажатии «Обновить графики» без проверки кэша исходных CSV. `process_logs` кэшируется `@st.cache_data`, однако в `process_log_v2` внутри может быть сетевой доступ для OHLC, что замедляет первый прогон.
- UI-поток: режим «По одному» строит все графики последовательно; при больших логах это может быть медленно и блокировать UI.
- Кодовая страница: текст и статусы на русском, но в исходнике есть «битые» отображения в консоли из‑за локали — содержимое само по себе корректно (UTF-8), но для отладки лучше держать английские строки или явно указывать кодировку при просмотре.

## Что можно улучшить/ускорить
- **Кэш входных данных**: использовать `st.cache_data`/`st.cache_resource` для результатов `process_log_v2` по пути файла + комиссии + параметрам. Это уберёт повторные скачивания OHLC и перестроение equity при тех же входных данных.
- **Ограничить пересчёт**: вынести выбор режимов/маски/папки из триггера перерасчёта; считать логи только по кнопке и по факту изменения списка файлов, а не при каждом изменении маски (сейчас пересчёт только по кнопке — сохраняем поведение).
- **Параллельная обработка**: при большом числе логов рассмотреть `concurrent.futures.ThreadPoolExecutor` внутри `process_logs` (только если `process_log_v2` потокобезопасен относительно файлов/загрузок).
- **Ленивая отрисовка per-log**: в режиме «По одному» можно показывать список и строить графики по нажатию, чтобы не строить все сразу. Либо ограничить количество развёрнутых по умолчанию.
- **UI-чистота**: унифицировать строки статуса и логгирование на английском для отладки; все пользовательские сообщения оставить на русском.
- **Ошибки/валидация**: добавить проверку доступности сети перед скачиванием OHLC (или чёткий текст «нужен интернет»), и понятные сообщения, если файл пустой/битый.
- **Сохранение настроек**: JSON-файл `dashboard_state.json` стоит чистить от устаревших ключей и валидировать путь; при ошибке записи показывать notice пользователю, а не только лог.
- **Типизация**: добавить явные возвраты для вспомогательных функций (folder dialog, apply_mask) и докстринги на английском — упростит поддержку.

## Быстрые технические правки, если будет время
- Исправить «битую» строку `DEFAULT_MODE` в исходнике на явный ASCII-комментарий или вынести в константу `DEFAULT_MODE = "Комбинация"` и рядом `ALLOWED_MODES = ("Комбинация", "По одному")`.
- Для экспорта CSV использовать `io.StringIO`/`BytesIO` и `st.download_button` с `mime="text/csv"` — уже ок, но можно добавить gzip-опцию для больших файлов.
- Добавить индикатор сетевого шага и опцию «пропустить скачивание OHLC, если файл уже есть», чтобы ускорить повторные прогоны.
